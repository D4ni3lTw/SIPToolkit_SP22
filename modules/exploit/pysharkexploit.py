import pyshark
from pydub import AudioSegment
# Open saved trace file
rtp_list =[]
pcap_file = 'data/packet_capture/1104_sound.pcapng'
audio_out = 'data/audio_out/audio_soundtest.raw'
cap = pyshark.FileCapture(str(pcap_file), display_filter='rtp')
raw_audio = open(audio_out,'wb')
# Sniff from interface
# capture = pyshark.LiveCapture(interface='eth0')
# capture.sniff(timeout=10)

for i in cap:
    try:
        rtp = i[3] # In packet, there are 4 layer. <ETH Layer>, <IP Layer>, <UDP Layer>, <RTP Layer>]. i[3] = RTP Layer
        if rtp.payload: #checking if have payload in RTP layers
            # print(rtp.payload)
            rtp_list.append(rtp.payload.split(":"))
    except:
        pass
for rtp_packet in rtp_list:
    packet = " ".join(rtp_packet)
    # print(packet)
    audio = bytearray.fromhex(packet)
    raw_audio.write(audio)


raw_audio = AudioSegment.from_file("data/audio_out/audio_soundtest.raw", format="raw",frame_rate=8000, channels=1, sample_width=2)
raw_audio.export("data/audio_out/audio_soundtest_format.mp3", format="mp3")

