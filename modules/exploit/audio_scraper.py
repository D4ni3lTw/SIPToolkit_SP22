import pyshark

class Audio_Scraper:
    def __init__(self, pcap, filter, outfile):
        self.pcap = pcap
        self.filter = filter
        self.outfile = outfile

    def scraper(self):
        rtp_list =[]
        capture = pyshark.LiveCapture('Ethernet0',output_file="/Users/LongTM4-DDC/test.pcapng")
        capture.sniff(timeout=20)
        pcap_file = ("/Users/LongTM4-DDC/%s" % self.pcap)
        out_file = ("/Users/LongTM4-DDC/%s" % self.outfile)
        print("Scraping: " + pcap_file)
        filter_type = self.filter
        cap = pyshark.FileCapture(pcap_file,display_filter=filter_type) # reading file capture and filter protocol
        raw_audio = open(out_file,'wb')


        for i in cap:
            try:
                rtp = i[3] # In packet, there are 4 layer. <ETH Layer>, <IP Layer>, <UDP Layer>, <RTP Layer>]. i[3] = RTP Layer
                if rtp.payload: #checking if have payload in RTP layers
                    print(rtp.payload)
                    rtp_list.append(rtp.payload.split(":"))
            except:
                pass
        for rtp_packet in rtp_list:
            packet = " ".join(rtp_packet)
            print(packet)
            audio = bytearray.fromhex(packet)
            raw_audio.write(audio)

        #print("\nPayload type is: ",a.rtp.p_type)
        print("\nFinished outputing raw audio: %s" % out_file)

# pcap_test = Audio_Scraper("my.pcap","rtp","my_audio.raw").scraper()